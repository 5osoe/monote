<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>menote</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f3d2e;
            --primary-hover: #164f3d;
            --accent: #2e8b57;
            --bg-body: #121212;
            --bg-panel: #1a1a1a;
            --bg-input: #242424;
            --text-main: #e0e0e0;
            --text-muted: #808080;
            --border: #333333;
            --danger: #cf6679;
            --warning: #d4a72c;
            --radius: 12px;
            --ease: cubic-bezier(0.4, 0.0, 0.2, 1);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        [dir="rtl"] { --dir: -1; }
        [dir="ltr"] { --dir: 1; }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100dvh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
        }

        button, input, textarea { border: none; background: none; color: inherit; font-family: inherit; outline: none; }
        button { cursor: pointer; }

        /* Icons & Utilities */
        .icon-btn { padding: 8px; border-radius: 50%; transition: background 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }
        .hidden { display: none !important; }

        /* Security Layer */
        #security-layer {
            position: fixed; inset: 0; background-color: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.3s var(--ease); padding: 20px;
        }

        .sec-header { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; }
        .brand { font-size: 2.5rem; font-weight: 300; color: var(--accent); letter-spacing: 2px; margin-bottom: 40px; }
        
        .auth-box { width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 15px; }
        
        .auth-input {
            width: 100%; padding: 16px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: var(--radius); font-size: 1rem; color: var(--text-main); transition: border-color 0.2s;
        }
        .auth-input:focus { border-color: var(--accent); }
        
        .auth-btn {
            padding: 16px; background: var(--primary); color: white; border-radius: var(--radius);
            font-weight: 500; font-size: 1rem; transition: background 0.2s;
        }
        .auth-btn:hover { background: var(--primary-hover); }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .auth-link { text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-top: 10px; text-decoration: underline; cursor: pointer; }
        .status-msg { text-align: center; min-height: 20px; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }

        /* App Layout */
        #app-layout {
            display: flex; width: 100%; height: 100%; min-height: 0; opacity: 0;
            pointer-events: none; transition: opacity 0.3s var(--ease);
        }
        #app-layout.visible { opacity: 1; pointer-events: all; }

        /* Sidebar */
        #sidebar {
            width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; transition: transform 0.2s var(--ease);
        }
        [dir="rtl"] #sidebar { border-right: none; border-left: 1px solid var(--border); }

        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .sidebar-actions { display: flex; gap: 10px; padding: 10px 20px; border-bottom: 1px solid var(--border); }
        
        #folder-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .folder-item {
            padding: 12px 16px; margin-bottom: 4px; border-radius: var(--radius); cursor: pointer;
            display: flex; justify-content: space-between; color: var(--text-muted); align-items: center;
        }
        .folder-item.active { background: var(--primary); color: white; }
        .folder-item i { font-style: normal; font-size: 0.8rem; margin-right: 5px; }
        .folder-delete { opacity: 0; color: var(--danger); padding: 0 5px; }
        .folder-item:hover .folder-delete { opacity: 1; }

        /* Main Content */
        #main-content {
            flex: 1; display: flex; flex-direction: column; background: var(--bg-body);
            position: relative; min-width: 0; min-height: 0;
        }

        .top-bar {
            height: 64px; padding: 0 20px; display: flex; align-items: center;
            border-bottom: 1px solid var(--border); gap: 15px; flex-shrink: 0;
        }
        
        .menu-toggle { display: none; font-size: 1.5rem; }
        .folder-info { flex: 1; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-input { width: 100%; max-width: 200px; background: var(--bg-input); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; }

        /* Notes Area */
        #notes-area { flex: 1; min-height: 0; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .note-card {
            background: var(--bg-panel); border-radius: var(--radius); padding: 16px;
            animation: fadeIn 0.2s var(--ease); flex-shrink: 0;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .note-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.75rem; color: var(--text-muted); align-items: center; }
        .note-actions { display: flex; gap: 10px; }
        .note-btn { cursor: pointer; transition: color 0.2s; }
        .note-btn:hover { color: var(--text-main); }
        
        .note-text { line-height: 1.5; white-space: pre-wrap; word-break: break-word; margin-top: 8px; }

        /* Image Grid System */
        .img-grid {
            display: grid; gap: 4px; border-radius: 8px; overflow: hidden; margin-bottom: 10px; width: 100%;
        }
        .img-grid img {
            width: 100%; height: 180px; object-fit: cover; display: block; cursor: pointer; transition: opacity 0.2s;
        }
        .img-grid img:hover { opacity: 0.9; }
        
        .g-1 { grid-template-columns: 1fr; }
        .g-2 { grid-template-columns: 1fr 1fr; }
        .g-3 { grid-template-columns: 1fr 1fr 1fr; }
        .g-more { grid-template-columns: 1fr 1fr; }
        .overlay-container { position: relative; }
        .more-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; pointer-events: none;
        }

        /* Input Area */
        .input-area {
            padding: 15px 20px; background: var(--bg-body); border-top: 1px solid var(--border);
            padding-bottom: calc(15px + var(--safe-bottom)); flex-shrink: 0; z-index: 10;
        }
        
        .file-preview {
            display: none; padding: 8px 12px; background: var(--bg-input); border-radius: var(--radius);
            margin-bottom: 10px; font-size: 0.85rem; color: var(--accent); justify-content: space-between;
        }
        
        .input-wrapper {
            display: flex; gap: 12px; align-items: flex-end; background: var(--bg-input);
            padding: 10px 15px; border-radius: 24px;
        }
        
        .note-input { flex: 1; max-height: 120px; resize: none; padding: 4px 0; font-size: 1rem; }
        .action-btn { font-size: 1.2rem; color: var(--text-muted); transition: color 0.2s; }
        .action-btn:hover { color: var(--accent); }

        /* Modals & Overlays */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none;
            align-items: center; justify-content: center; z-index: 10000;
        }
        
        .modal { background: var(--bg-panel); padding: 24px; border-radius: var(--radius); width: 90%; max-width: 360px; }
        .modal h3 { margin-bottom: 16px; color: var(--text-main); }
        .modal p { color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5; }
        
        #image-viewer { background: rgba(0,0,0,0.95); z-index: 20000; flex-direction: column; }
        #full-image { max-width: 95vw; max-height: 85vh; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .viewer-controls { margin-top: 20px; display: flex; gap: 20px; }
        .viewer-btn { color: white; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 20px; }

        .recovery-key-box {
            background: var(--bg-input); padding: 15px; border-radius: 8px; word-break: break-all;
            font-family: monospace; color: var(--warning); border: 1px dashed var(--warning); margin-bottom: 20px;
        }

        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--text-muted); font-size: 0.9rem; }
        .checkbox-wrapper input { width: auto; }

        .btn-row { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-primary { background: var(--primary); color: white; padding: 8px 16px; border-radius: 6px; }
        .btn-secondary { color: var(--text-muted); padding: 8px 16px; }

        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--bg-panel); border: 1px solid var(--border); padding: 10px 20px;
            border-radius: 50px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 30000;
        }

        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; transform: translateX(-100%); box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
            [dir="rtl"] #sidebar { transform: translateX(100%); }
            #sidebar.open { transform: translateX(0); }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>

    <!-- Security Layer -->
    <div id="security-layer">
        <div class="sec-header">
            <button id="lang-btn-sec" class="auth-btn" style="padding: 5px 10px; font-size: 0.8rem;">EN</button>
            <button id="help-btn-sec" class="auth-btn" style="padding: 5px 10px; font-size: 0.8rem;">?</button>
        </div>
        <div class="brand">menote</div>
        
        <!-- Login -->
        <div id="login-form" class="auth-box">
            <div class="status-msg" id="login-msg" data-i18n="enterPass">Enter Passphrase</div>
            <input type="password" id="login-pass" class="auth-input" placeholder="Passphrase" autocomplete="off">
            <button id="login-btn" class="auth-btn" data-i18n="unlock">Unlock</button>
            <div class="auth-link" id="goto-recovery" data-i18n="forgotPass">Forgot Passphrase?</div>
        </div>

        <!-- Setup -->
        <div id="setup-form" class="auth-box" style="display:none;">
            <div class="status-msg" style="color:var(--accent)" data-i18n="createVault">Create Secure Vault</div>
            <input type="password" id="setup-pass" class="auth-input" placeholder="New Passphrase (min 8 chars)">
            <input type="password" id="setup-pass-conf" class="auth-input" placeholder="Confirm Passphrase">
            <button id="setup-btn" class="auth-btn" data-i18n="create">Create Vault</button>
        </div>

        <!-- Recovery -->
        <div id="recovery-form" class="auth-box" style="display:none;">
            <div class="status-msg" style="color:var(--warning)" data-i18n="recoveryTitle">Account Recovery</div>
            <input type="text" id="rec-key-input" class="auth-input" placeholder="Paste Recovery Key">
            <button id="rec-verify-btn" class="auth-btn" data-i18n="verifyKey">Verify Key</button>
            <div id="rec-new-pass-area" style="display:none; gap:10px; flex-direction:column; margin-top:10px;">
                <input type="password" id="rec-new-pass" class="auth-input" placeholder="New Passphrase">
                <button id="rec-reset-btn" class="auth-btn" style="background:var(--warning); color:black" data-i18n="resetUnlock">Reset & Unlock</button>
            </div>
            <div class="auth-link" id="back-to-login" data-i18n="backLogin">Back to Login</div>
        </div>
    </div>

    <!-- Application Layer -->
    <div id="app-layout">
        <aside id="sidebar">
            <div class="sidebar-header">
                <h3 data-i18n="folders">Folders</h3>
                <div style="display:flex; gap:5px;">
                    <button id="lang-btn-app" class="icon-btn" style="font-size:0.8rem">EN</button>
                    <button id="help-btn-app" class="icon-btn">?</button>
                </div>
            </div>
            <div class="sidebar-actions">
                <button id="add-folder-btn" class="btn-secondary" style="font-size:0.8rem; width:100%" data-i18n="newFolder">+ New Folder</button>
                <button id="vault-btn" class="btn-secondary" style="font-size:0.8rem; color:var(--warning); width:100%">&#128274;</button>
            </div>
            <div id="folder-list"></div>
        </aside>

        <main id="main-content">
            <header class="top-bar">
                <button id="menu-toggle" class="menu-toggle">&#9776;</button>
                <div class="folder-info" id="current-folder-title">General</div>
                <input type="text" id="search-input" class="search-input" placeholder="Search...">
            </header>

            <div id="notes-area"></div>

            <div class="input-area">
                <div id="file-preview" class="file-preview">
                    <span id="file-count"></span>
                    <button id="remove-file" style="color:var(--danger)">&#10005;</button>
                </div>
                <div class="input-wrapper">
                    <input type="file" id="file-input" hidden accept="image/*" multiple>
                    <button id="attach-btn" class="action-btn">&#128444;</button>
                    <textarea id="note-input" class="note-input" rows="1" placeholder="Secure note..."></textarea>
                    <button id="send-btn" class="action-btn" style="color:var(--accent)">&#10148;</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-folder" class="modal-overlay">
        <div class="modal">
            <h3 data-i18n="newFolder">New Folder</h3>
            <input type="text" id="modal-folder-input" class="auth-input" placeholder="Name">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="modal-folder-hidden">
                <span style="color:var(--warning)" data-i18n="hiddenLabel">Hidden (Highly Sensitive)</span>
            </div>
            <div class="btn-row">
                <button id="modal-folder-cancel" class="btn-secondary" data-i18n="cancel">Cancel</button>
                <button id="modal-folder-save" class="btn-primary" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-reveal" class="modal-overlay">
        <div class="modal">
            <h3 style="color:var(--warning)" data-i18n="revealVault">Reveal Hidden Vault</h3>
            <p data-i18n="revealDesc">Enter your Recovery Key to temporarily reveal hidden folders.</p>
            <input type="text" id="reveal-key-input" class="auth-input" placeholder="Recovery Key">
            <div class="btn-row" style="margin-top:15px">
                <button id="reveal-cancel" class="btn-secondary" data-i18n="cancel">Cancel</button>
                <button id="reveal-confirm" class="btn-primary" data-i18n="reveal">Reveal</button>
            </div>
        </div>
    </div>

    <div id="modal-recovery" class="modal-overlay">
        <div class="modal">
            <h3 style="color:var(--warning)" data-i18n="saveKeyTitle">⚠️ SAVE THIS KEY</h3>
            <p data-i18n="saveKeyDesc">This is your only way to recover notes or access hidden folders.</p>
            <div class="recovery-key-box" id="new-recovery-key"></div>
            <div class="btn-row">
                <button id="copy-rec-btn" class="btn-secondary" data-i18n="copy">Copy</button>
                <button id="close-rec-modal" class="btn-primary" data-i18n="iSavedIt">I have saved it</button>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay">
        <div class="modal">
            <h3 data-i18n="helpTitle">Help & Info</h3>
            <p id="help-content" style="white-space: pre-line; font-size: 0.85rem;"></p>
            <div class="btn-row">
                <button id="close-help" class="btn-primary" data-i18n="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer -->
    <div id="image-viewer" class="modal-overlay">
        <img id="full-image" src="" alt="Full View">
        <div class="viewer-controls">
            <button id="download-img-btn" class="viewer-btn" data-i18n="download">Download</button>
            <button id="close-img-btn" class="viewer-btn" data-i18n="close">Close</button>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // --- Translations ---
        const i18n = {
            en: {
                enterPass: 'Enter Passphrase', unlock: 'Unlock', forgotPass: 'Forgot Passphrase?',
                createVault: 'Create Secure Vault', create: 'Create Vault', recoveryTitle: 'Account Recovery',
                verifyKey: 'Verify Key', resetUnlock: 'Reset & Unlock', backLogin: 'Back to Login',
                folders: 'Folders', newFolder: 'New Folder', hiddenLabel: 'Hidden (Highly Sensitive)',
                cancel: 'Cancel', save: 'Save', revealVault: 'Reveal Hidden Vault',
                revealDesc: 'Enter Recovery Key to reveal.', reveal: 'Reveal',
                saveKeyTitle: '⚠️ SAVE THIS KEY', saveKeyDesc: 'Only way to recover or access hidden folders.',
                copy: 'Copy', iSavedIt: 'I have saved it', helpTitle: 'Help', close: 'Close',
                download: 'Download', copied: 'Copied', invalidKey: 'Invalid Key',
                helpSecText: "• Passphrase: Encrypts your data.\n• Recovery Key: The ONLY way to reset password or open Hidden Folders.\n• Lockout: 5 failed attempts locks the app for 30s.",
                helpAppText: "• Create Folder: Use + button.\n• Hidden Folders: Visible only via Recovery Key.\n• Images: Select multiple images for grid view.\n• Copy: Click clipboard icon.\n• Download: Click image then download.",
                search: "Search...", typeNote: "Secure note..."
            },
            ar: {
                enterPass: 'أدخل كلمة المرور', unlock: 'فتح', forgotPass: 'نسيت كلمة المرور؟',
                createVault: 'إنشاء محفظة آمنة', create: 'إنشاء', recoveryTitle: 'استعادة الحساب',
                verifyKey: 'تحقق من المفتاح', resetUnlock: 'إعادة تعيين وفتح', backLogin: 'عودة للدخول',
                folders: 'المجلدات', newFolder: 'مجلد جديد', hiddenLabel: 'مخفي (حساس جداً)',
                cancel: 'إلغاء', save: 'حفظ', revealVault: 'كشف الخزنة المخفية',
                revealDesc: 'أدخل مفتاح الاستعادة للكشف.', reveal: 'كشف',
                saveKeyTitle: '⚠️ احفظ هذا المفتاح', saveKeyDesc: 'الطريقة الوحيدة للاستعادة أو فتح المجلدات المخفية.',
                copy: 'نسخ', iSavedIt: 'تم الحفظ', helpTitle: 'مساعدة', close: 'إغلاق',
                download: 'تحميل', copied: 'تم النسخ', invalidKey: 'مفتاح غير صحيح',
                helpSecText: "• كلمة المرور: تشفر بياناتك.\n• مفتاح الاستعادة: الطريقة الوحيدة لإعادة التعيين أو فتح المجلدات المخفية.\n• القفل: 5 محاولات خاطئة تقفل التطبيق 30 ثانية.",
                helpAppText: "• مجلد جديد: استخدم زر +.\n• المجلدات المخفية: تظهر فقط بمفتاح الاستعادة.\n• الصور: اختر صور متعددة للعرض الشبكي.\n• النسخ: اضغط أيقونة الحافظة.\n• التحميل: اضغط الصورة ثم تحميل.",
                search: "بحث...", typeNote: "ملاحظة آمنة..."
            }
        };

        // --- Config ---
        const DB_NAME = 'menote_v3';
        const PBKDF2_ITERATIONS = 300000;
        const SALT_LEN = 16;
        const IV_LEN = 12;
        const REC_KEY_LEN = 32;
        const LOCKOUT_RULES = { 5: 30, 10: 120, 15: 600 };

        const State = {
            db: null, masterKey: null, folderId: 1, tempFiles: [], 
            searchTimer: null, tempRecKey: null, revealHidden: false, 
            lang: 'en', fullImgBlob: null, objectUrls: []
        };

        const El = {
            sec: document.getElementById('security-layer'), app: document.getElementById('app-layout'),
            loginForm: document.getElementById('login-form'), setupForm: document.getElementById('setup-form'),
            recForm: document.getElementById('recovery-form'), notes: document.getElementById('notes-area')
        };

        // --- Init ---
        async function init() {
            await openDB();
            const config = await getConfig();
            if(config && config.lang) setLang(config.lang);
            else setLang('en');
            
            if (!config) {
                showSetup();
            } else {
                showLogin();
                checkLockout(config);
            }
            
            updateUI();
            bindEvents();
        }

        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('config')) db.createObjectStore('config', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('folders')) {
                        const s = db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true });
                        s.put({ id: 1, name: 'General', hidden: false });
                    }
                    if (!db.objectStoreNames.contains('notes')) {
                        const s = db.createObjectStore('notes', { keyPath: 'id', autoIncrement: true });
                        s.createIndex('folderId', 'folderId');
                    }
                };
                req.onsuccess = (e) => { State.db = e.target.result; resolve(); };
                req.onerror = reject;
            });
        }

        function getConfig() {
            return new Promise(r => {
                const tx = State.db.transaction('config', 'readonly');
                tx.objectStore('config').get('main').onsuccess = e => r(e.target.result);
            });
        }

        // --- I18n ---
        function setLang(lang) {
            State.lang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('lang-btn-sec').textContent = lang.toUpperCase();
            document.getElementById('lang-btn-app').textContent = lang.toUpperCase();
            updateUI();
        }

        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if(i18n[State.lang][key]) el.textContent = i18n[State.lang][key];
            });
            document.getElementById('search-input').placeholder = i18n[State.lang].search;
            document.getElementById('note-input').placeholder = i18n[State.lang].typeNote;
        }

        async function saveLangConfig(lang) {
            const config = await getConfig();
            if(config) {
                config.lang = lang;
                const tx = State.db.transaction('config', 'readwrite');
                tx.objectStore('config').put(config);
            }
        }

        function toggleLang() {
            const newLang = State.lang === 'en' ? 'ar' : 'en';
            setLang(newLang);
            if(State.masterKey) saveLangConfig(newLang);
        }

        // --- Crypto ---
        function generateSalt() { return crypto.getRandomValues(new Uint8Array(SALT_LEN)); }
        function generateIV() { return crypto.getRandomValues(new Uint8Array(IV_LEN)); }
        async function generateMasterKey() { return crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']); }
        
        async function deriveKeyFromPass(pass, salt) {
            const enc = new TextEncoder();
            const keyMat = await crypto.subtle.importKey('raw', enc.encode(pass), { name: 'PBKDF2' }, false, ['deriveKey']);
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITERATIONS, hash: 'SHA-256' },
                keyMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt', 'wrapKey', 'unwrapKey']
            );
        }

        // --- Folders (DOM Elements) ---
        function loadFolders() {
            const tx = State.db.transaction('folders', 'readonly');
            tx.objectStore('folders').getAll().onsuccess = e => {
                const list = document.getElementById('folder-list');
                list.innerHTML = '';
                e.target.result.forEach(f => {
                    if(f.hidden && !State.revealHidden) return;
                    
                    const el = document.createElement('div');
                    el.className = `folder-item ${f.id === State.folderId ? 'active' : ''}`;
                    
                    const icon = document.createElement('i');
                    icon.innerHTML = f.hidden ? '&#128065; ' : '';
                    
                    const span = document.createElement('span');
                    span.textContent = f.name;
                    span.prepend(icon);
                    
                    el.appendChild(span);
                    
                    if (f.id !== 1) {
                        const btn = document.createElement('span');
                        btn.className = 'folder-delete';
                        btn.innerHTML = '&times;';
                        btn.addEventListener('click', (ev) => { 
                            ev.stopPropagation(); 
                            deleteFolder(f.id); 
                        });
                        el.appendChild(btn);
                    }
                    
                    el.addEventListener('click', () => { 
                        State.folderId = f.id; 
                        document.getElementById('current-folder-title').textContent = f.name; 
                        loadFolders(); 
                        loadNotes(); 
                    });
                    
                    list.appendChild(el);
                });
            };
        }

        // --- Notes (DOM Elements) ---
        function loadNotes() {
            // Clean up old object URLs
            State.objectUrls.forEach(url => URL.revokeObjectURL(url));
            State.objectUrls = [];

            const tx = State.db.transaction('notes', 'readonly');
            tx.objectStore('notes').index('folderId').getAll(State.folderId).onsuccess = async e => {
                const notes = e.target.result;
                const container = document.getElementById('notes-area');
                container.innerHTML = '';
                const frag = document.createDocumentFragment();

                for (const note of notes) {
                    const div = document.createElement('div');
                    div.className = 'note-card';
                    
                    const text = await decryptContent(note.content, note.iv);
                    const date = new Date(note.ts).toLocaleString();

                    // Header
                    const header = document.createElement('div');
                    header.className = 'note-header';
                    const dateSpan = document.createElement('span');
                    dateSpan.textContent = date;
                    
                    const actions = document.createElement('div');
                    actions.className = 'note-actions';
                    
                    const copyBtn = document.createElement('span');
                    copyBtn.className = 'note-btn';
                    copyBtn.innerHTML = '&#128203;';
                    copyBtn.addEventListener('click', () => copyText(text));

                    const delBtn = document.createElement('span');
                    delBtn.className = 'note-btn';
                    delBtn.style.color = 'var(--danger)';
                    delBtn.innerHTML = '&times;';
                    delBtn.addEventListener('click', () => deleteNote(note.id));

                    actions.appendChild(copyBtn);
                    actions.appendChild(delBtn);
                    header.appendChild(dateSpan);
                    header.appendChild(actions);
                    div.appendChild(header);

                    // Images
                    let images = note.images || (note.imgEnc ? [{data: note.imgEnc, iv: note.imgIv}] : []);
                    
                    if (images.length > 0) {
                        const decryptedImgs = await Promise.all(images.map(async img => {
                            const buf = await decryptContent(img.data, img.iv, true);
                            const url = URL.createObjectURL(new Blob([buf]));
                            State.objectUrls.push(url);
                            return url;
                        }));

                        const grid = document.createElement('div');
                        let gridClass = 'g-1';
                        if(images.length === 2) gridClass = 'g-2';
                        else if(images.length === 3) gridClass = 'g-3';
                        else if(images.length >= 4) gridClass = 'g-more';
                        
                        grid.className = `img-grid ${gridClass}`;

                        decryptedImgs.forEach((url, i) => {
                            if(i > 3) return;
                            
                            const imgContainer = document.createElement('div');
                            if(i === 3 && images.length > 4) imgContainer.className = 'overlay-container';
                            
                            const img = document.createElement('img');
                            img.src = url;
                            img.addEventListener('click', () => viewImage(url));
                            imgContainer.appendChild(img);

                            if(i === 3 && images.length > 4) {
                                const overlay = document.createElement('div');
                                overlay.className = 'more-overlay';
                                overlay.textContent = `+${images.length - 4}`;
                                imgContainer.appendChild(overlay);
                            }
                            grid.appendChild(imgContainer);
                        });
                        div.appendChild(grid);
                    }

                    const content = document.createElement('div');
                    content.className = 'note-text';
                    content.textContent = text; // Safe text content
                    div.appendChild(content);

                    frag.appendChild(div);
                }
                container.appendChild(frag);
                container.scrollTop = container.scrollHeight;
            };
        }

        async function saveNote() {
            const txt = document.getElementById('note-input').value.trim();
            const files = State.tempFiles;
            if (!txt && files.length === 0) return;

            const textEnc = await encryptContent(txt);
            const encryptedImages = [];

            for(const f of files) {
                const buf = await f.arrayBuffer();
                const res = await encryptContent(buf);
                encryptedImages.push({ data: res.data, iv: res.iv });
            }

            const note = {
                folderId: State.folderId, content: textEnc.data, iv: textEnc.iv, ts: Date.now(),
                images: encryptedImages
            };

            const tx = State.db.transaction('notes', 'readwrite');
            tx.objectStore('notes').add(note);
            tx.oncomplete = () => {
                document.getElementById('note-input').value = '';
                document.getElementById('note-input').style.height = 'auto';
                clearFiles();
                loadNotes();
            };
        }

        // --- Helpers ---
        function copyText(text) {
            navigator.clipboard.writeText(text);
            showToast(i18n[State.lang].copied);
        }

        function deleteNote(id) {
            if(confirm('Delete?')) {
                const tx = State.db.transaction('notes', 'readwrite');
                tx.objectStore('notes').delete(id);
                tx.oncomplete = () => loadNotes();
            }
        }
        
        function deleteFolder(id) {
            if(confirm('Delete folder?')) {
                const tx = State.db.transaction(['folders', 'notes'], 'readwrite');
                tx.objectStore('folders').delete(id);
                const idx = tx.objectStore('notes').index('folderId');
                idx.getAllKeys(id).onsuccess = e => { e.target.result.forEach(k => tx.objectStore('notes').delete(k)); };
                tx.oncomplete = () => { State.folderId = 1; loadFolders(); loadNotes(); };
            }
        }

        function showSetup() {
            El.loginForm.style.display = 'none';
            El.recForm.style.display = 'none';
            El.setupForm.style.display = 'flex';
        }

        function showLogin() {
            El.setupForm.style.display = 'none';
            El.recForm.style.display = 'none';
            El.loginForm.style.display = 'flex';
        }

        // --- Event Bindings ---
        function bindEvents() {
            // Send Logic
            document.getElementById('send-btn').addEventListener('click', saveNote);
            document.getElementById('note-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveNote();
                }
            });

            // File Inputs
            document.getElementById('attach-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', e => {
                const files = Array.from(e.target.files);
                const valid = files.filter(f => f.type.startsWith('image/') && f.size < 5*1024*1024);
                if(valid.length) {
                    State.tempFiles = valid;
                    document.getElementById('file-count').textContent = `${valid.length} image(s)`;
                    document.getElementById('file-preview').style.display = 'flex';
                }
                e.target.value = '';
            });
            document.getElementById('remove-file').addEventListener('click', clearFiles);

            // Setup & Login
            document.getElementById('setup-btn').addEventListener('click', setupVault);
            document.getElementById('login-btn').addEventListener('click', performLogin);
            
            // Recovery
            document.getElementById('goto-recovery').addEventListener('click', () => { El.loginForm.style.display = 'none'; El.recForm.style.display = 'flex'; });
            document.getElementById('back-to-login').addEventListener('click', () => { El.recForm.style.display = 'none'; El.loginForm.style.display = 'flex'; });
            document.getElementById('rec-verify-btn').addEventListener('click', verifyRecovery);
            document.getElementById('rec-reset-btn').addEventListener('click', resetVault);

            // Modals
            document.getElementById('add-folder-btn').addEventListener('click', () => {
                document.getElementById('modal-folder').style.display = 'flex';
                document.getElementById('modal-folder-hidden').checked = false;
            });
            document.getElementById('modal-folder-cancel').addEventListener('click', () => document.getElementById('modal-folder').style.display = 'none');
            document.getElementById('modal-folder-save').addEventListener('click', saveFolder);
            
            // Vault Reveal
            document.getElementById('vault-btn').addEventListener('click', toggleVault);
            document.getElementById('reveal-cancel').addEventListener('click', () => document.getElementById('modal-reveal').style.display = 'none');
            document.getElementById('reveal-confirm').addEventListener('click', confirmReveal);
            
            // Help & Lang
            document.getElementById('lang-btn-sec').addEventListener('click', toggleLang);
            document.getElementById('lang-btn-app').addEventListener('click', toggleLang);
            document.getElementById('help-btn-sec').addEventListener('click', () => openHelp('sec'));
            document.getElementById('help-btn-app').addEventListener('click', () => openHelp('app'));
            document.getElementById('close-help').addEventListener('click', () => document.getElementById('modal-help').style.display = 'none');

            // Image Viewer
            document.getElementById('close-img-btn').addEventListener('click', closeImageViewer);
            document.getElementById('download-img-btn').addEventListener('click', downloadImage);

            // Misc
            document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('open'));
            document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('menu-toggle');

    if (
        window.innerWidth <= 768 &&
        sidebar.classList.contains('open') &&
        !sidebar.contains(e.target) &&
        !toggle.contains(e.target)
    ) {
        sidebar.classList.remove('open');
    }
});
            document.getElementById('search-input').addEventListener('input', e => {
                clearTimeout(State.searchTimer);
                State.searchTimer = setTimeout(() => {
                    // Re-load notes (decryption happens in loadNotes, simplified search here would need structural change to index)
                    // For security, we just reload all and filter or keep current simple reload
                    loadNotes(); 
                }, 300);
            });
            
            document.getElementById('copy-rec-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('new-recovery-key').textContent);
                showToast(i18n[State.lang].copied);
            });
            document.getElementById('close-rec-modal').addEventListener('click', () => {
                document.getElementById('modal-recovery').style.display = 'none';
                unlockUI();
            });

            // Auto-resize
            document.getElementById('note-input').addEventListener('input', function() {
                this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
            });
        }

        // --- Logic implementations ---

        async function setupVault() {
            const p1 = document.getElementById('setup-pass').value;
            const p2 = document.getElementById('setup-pass-conf').value;
            if (p1.length < 8) return showToast('Min 8 characters');
            if (p1 !== p2) return showToast('Passphrases do not match');

            const masterKey = await generateMasterKey();
            const salt = generateSalt();
            const keyFromPass = await deriveKeyFromPass(p1, salt);
            const ivPass = generateIV();
            const wrappedMasterKey = await crypto.subtle.wrapKey('raw', masterKey, keyFromPass, { name: 'AES-GCM', iv: ivPass });

            const recBytes = crypto.getRandomValues(new Uint8Array(REC_KEY_LEN));
            const recHex = Array.from(recBytes).map(b => b.toString(16).padStart(2,'0')).join('');
            const keyFromRec = await deriveKeyFromPass(recHex, salt);
            const ivRec = generateIV();
            const wrappedRecToken = await crypto.subtle.wrapKey('raw', masterKey, keyFromRec, { name: 'AES-GCM', iv: ivRec });

            const config = {
                id: 'main', salt, wrappedMasterKey, ivPass, wrappedRecToken, ivRec, attempts: 0, lockout: 0, lang: State.lang
            };

            const tx = State.db.transaction('config', 'readwrite');
            tx.objectStore('config').put(config);
            tx.oncomplete = () => {
                document.getElementById('new-recovery-key').textContent = recHex;
                document.getElementById('modal-recovery').style.display = 'flex';
                State.masterKey = masterKey;
            };
        }

        async function performLogin() {
            const pass = document.getElementById('login-pass').value;
            const config = await getConfig();
            if (Date.now() < config.lockout) return;

            try {
                const keyFromPass = await deriveKeyFromPass(pass, config.salt);
                const masterKey = await crypto.subtle.unwrapKey(
                    'raw', config.wrappedMasterKey, keyFromPass, 
                    { name: 'AES-GCM', iv: config.ivPass }, 
                    { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']
                );
                State.masterKey = masterKey;
                resetAttempts(config);
                unlockUI();
            } catch (e) { handleFail(config); }
        }

        async function checkLockout(config) {
            const now = Date.now();
            if (now < config.lockout) {
                const wait = Math.ceil((config.lockout - now) / 1000);
                document.getElementById('login-msg').textContent = `Locked. Wait ${wait}s`;
                document.getElementById('login-msg').style.color = 'var(--danger)';
                document.getElementById('login-btn').disabled = true;
                setTimeout(() => checkLockout(config), 1000);
            } else {
                document.getElementById('login-msg').textContent = i18n[State.lang].enterPass;
                document.getElementById('login-msg').style.color = 'var(--text-muted)';
                document.getElementById('login-btn').disabled = false;
            }
        }

        function handleFail(config) {
            config.attempts = (config.attempts || 0) + 1;
            let dur = 0;
            if (config.attempts >= 15) dur = LOCKOUT_RULES[15];
            else if (config.attempts >= 10) dur = LOCKOUT_RULES[10];
            else if (config.attempts >= 5) dur = LOCKOUT_RULES[5];
            if (dur > 0) config.lockout = Date.now() + (dur * 1000);
            
            const tx = State.db.transaction('config', 'readwrite');
            tx.objectStore('config').put(config);
            tx.oncomplete = () => { showToast(`Incorrect. Attempts: ${config.attempts}`); checkLockout(config); };
        }

        function resetAttempts(config) {
            config.attempts = 0; config.lockout = 0;
            const tx = State.db.transaction('config', 'readwrite');
            tx.objectStore('config').put(config);
        }

        function unlockUI() {
            El.sec.style.opacity = '0';
            setTimeout(() => { El.sec.style.display = 'none'; El.app.classList.add('visible'); loadFolders(); loadNotes(); }, 300);
        }

        async function verifyRecovery() {
            const keyStr = document.getElementById('rec-key-input').value.trim();
            const config = await getConfig();
            try {
                const keyFromRec = await deriveKeyFromPass(keyStr, config.salt);
                const masterKey = await crypto.subtle.unwrapKey(
                    'raw', config.wrappedRecToken, keyFromRec,
                    { name: 'AES-GCM', iv: config.ivRec },
                    { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']
                );
                State.masterKey = masterKey;
                State.tempRecKey = keyStr;
                document.getElementById('rec-verify-btn').style.display = 'none';
                document.getElementById('rec-key-input').disabled = true;
                document.getElementById('rec-new-pass-area').style.display = 'flex';
                showToast('Verified');
            } catch (e) { showToast(i18n[State.lang].invalidKey); }
        }

        async function resetVault() {
            const newPass = document.getElementById('rec-new-pass').value;
            if (newPass.length < 8) return showToast('Min 8 characters');
            
            const config = await getConfig();
            const salt = generateSalt();
            const ivPass = generateIV();
            const keyFromPass = await deriveKeyFromPass(newPass, salt);
            const wrappedMasterKey = await crypto.subtle.wrapKey('raw', State.masterKey, keyFromPass, { name: 'AES-GCM', iv: ivPass });

            const ivRec = generateIV();
            const keyFromRec = await deriveKeyFromPass(State.tempRecKey, salt);
            const wrappedRecToken = await crypto.subtle.wrapKey('raw', State.masterKey, keyFromRec, { name: 'AES-GCM', iv: ivRec });

            Object.assign(config, { salt, wrappedMasterKey, ivPass, wrappedRecToken, ivRec, attempts: 0, lockout: 0 });
            const tx = State.db.transaction('config', 'readwrite');
            tx.objectStore('config').put(config);
            tx.oncomplete = () => location.reload();
        }

        // --- Features ---
        function toggleVault() {
            if(State.revealHidden) {
                State.revealHidden = false;
                loadFolders();
                showToast('Vault Hidden');
            } else {
                document.getElementById('modal-reveal').style.display = 'flex';
                document.getElementById('reveal-key-input').value = '';
            }
        }

        async function confirmReveal() {
            const key = document.getElementById('reveal-key-input').value.trim();
            const config = await getConfig();
            try {
                const keyFromRec = await deriveKeyFromPass(key, config.salt);
                await crypto.subtle.unwrapKey(
                    'raw', config.wrappedRecToken, keyFromRec,
                    { name: 'AES-GCM', iv: config.ivRec },
                    { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']
                );
                State.revealHidden = true;
                document.getElementById('modal-reveal').style.display = 'none';
                loadFolders();
                showToast('Vault Revealed');
            } catch(e) { showToast(i18n[State.lang].invalidKey); }
        }

        function saveFolder() {
            const name = document.getElementById('modal-folder-input').value.trim();
            const hidden = document.getElementById('modal-folder-hidden').checked;
            if(name) {
                const tx = State.db.transaction('folders', 'readwrite');
                tx.objectStore('folders').add({ name, hidden });
                tx.oncomplete = () => { document.getElementById('modal-folder').style.display = 'none'; loadFolders(); };
            }
        }

        function clearFiles() { State.tempFiles = []; document.getElementById('file-preview').style.display = 'none'; }

        function openHelp(context) {
            const text = context === 'sec' ? i18n[State.lang].helpSecText : i18n[State.lang].helpAppText;
            document.getElementById('help-content').textContent = text;
            document.getElementById('modal-help').style.display = 'flex';
        }

        function viewImage(url) {
            const modal = document.getElementById('image-viewer');
            const img = document.getElementById('full-image');
            img.src = url;
            modal.style.display = 'flex';
            fetch(url).then(r => r.blob()).then(blob => State.fullImgBlob = blob);
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').style.display = 'none';
            // Revoke the blob URL created for download if any, but we use the main objectURL
            State.fullImgBlob = null;
        }

        function downloadImage() {
            if(State.fullImgBlob) {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(State.fullImgBlob);
                a.download = `menote-image-${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(a.href);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        // --- Crypto & Enc/Dec (Untouched Logic) ---
        async function encryptContent(data) {
            const iv = generateIV();
            let encodedData = typeof data === 'string' ? new TextEncoder().encode(data) : data;
            const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, State.masterKey, encodedData);
            return { iv, data: ciphertext };
        }
        async function decryptContent(data, iv, isBinary = false) {
            try {
                const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, State.masterKey, data);
                return isBinary ? dec : new TextDecoder().decode(dec);
            } catch (e) { return '[Error]'; }
        }

        init();
    </script>
</body>
</html>